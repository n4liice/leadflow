# ============================================
# LeadFlow Pro - Deploy AutomÃ¡tico para VPS
# ============================================
# Dispara automaticamente quando hÃ¡ push na branch main
# Requer secrets configurados no GitHub:
#   - VPS_HOST: IP ou hostname da VPS
#   - VPS_USER: UsuÃ¡rio SSH
#   - VPS_SSH_KEY: Chave privada SSH
#   - VITE_SUPABASE_URL: URL do Supabase
#   - VITE_SUPABASE_PUBLISHABLE_KEY: Chave pÃºblica do Supabase
#   - VITE_WEBHOOK_PROXY_URL: URL do Cloudflare Worker

name: Deploy LeadFlow to VPS

on:
  push:
    branches: [main]
    paths:
      - 'leadflow-pro/**'
      - '!leadflow-pro/README.md'
      - '!leadflow-pro/DOCUMENTATION.md'

  # Permite execuÃ§Ã£o manual
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "ðŸš€ Iniciando deploy do LeadFlow..."

            # Navegar para o diretÃ³rio
            cd /opt/leadflow || { echo "âŒ DiretÃ³rio nÃ£o encontrado"; exit 1; }

            # Pull das Ãºltimas alteraÃ§Ãµes
            echo "ðŸ“¥ Baixando alteraÃ§Ãµes..."
            git pull origin main

            # Entrar na pasta do projeto
            cd leadflow-pro

            # Criar/atualizar .env com secrets
            echo "ðŸ” Configurando variÃ¡veis de ambiente..."
            cat > .env << EOF
            VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}
            VITE_SUPABASE_PUBLISHABLE_KEY=${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}
            VITE_WEBHOOK_PROXY_URL=${{ secrets.VITE_WEBHOOK_PROXY_URL }}
            EOF

            # Rebuild e restart do container
            echo "ðŸ³ Rebuilding container..."
            docker compose down
            docker compose build --no-cache
            docker compose up -d

            # Limpar imagens antigas
            echo "ðŸ§¹ Limpando imagens antigas..."
            docker image prune -f

            # Verificar status
            echo "âœ… Deploy concluÃ­do!"
            docker compose ps
